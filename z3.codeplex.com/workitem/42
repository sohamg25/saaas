

<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" class="">
    
    
    
    

    
    <head>
        <meta id="CompatabilityMode" http-equiv="X-UA-Compatible" content="IE=edge" />
	    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <link href="http://download-codeplex.sec.s-msft.com/css/v20552/i1972231/StyleSheet.ashx" id="MasterCss" rel="stylesheet" type="text/css" />
        <link rel="SHORTCUT ICON" href="http://www.codeplex.com/favicon.ico" />
        <title>Z3 - View Issue &#35;42&#58; deadlock in free on timeout on win64</title>
        
        <!--
        Third party scripts and code linked to or referenced from this website are licensed to you by the parties that own such code,
        not by Microsoft.  See ASP.NET Ajax CDN Terms of Use – http://www.asp.net/ajaxlibrary/CDN.ashx.
        -->
        <script src="http://ajax.aspnetcdn.com/ajax/jquery/jquery-1.4.4.min.js" type="text/javascript"></script>
        <script src="http://ajax.aspnetcdn.com/ajax/jquery.ui/1.8.6/jquery-ui.min.js" type="text/javascript"></script>
        
        
    <style type="text/css">.SideBar, .SideBarPadding{display:none;}.MainContent{width:auto;}.SiteContentTable{width:100%;}</style>
    <style id="ProjectStyles" type="text/css">
        .SiteHeader, .SiteHeaderLeft {
            height:45px !important;
            overflow:hidden;
        }
        .SiteContent 
        {
            padding: 0 0 1em 0;
            margin-top:0;
            min-height:225px;
            border-right: 1px solid lightgrey;
            border-left: 1px solid lightgrey;
            border-bottom: 1px solid lightgrey;
        }
        .IE table.MinWidthContent
        {
	        table-layout: auto !important;	
        }
    </style>
    
    
    
    
    <meta id="WTProjectName" name="WT.pi" content="z3"/>
    

    <link rel="EditURI" type="application/rsd+xml" title="RSD" href='http://z3.codeplex.com/rsd' />
    <link rel="wlwmanifest" type="application/wlwmanifest+xml" title="WLWManifest" href='/wlwmanifest.xml' />
    
    
        <link rel="alternate" type="application/rss+xml" title="Z3" url="http://z3.codeplex.com/project/feeds/rss"/>
    
        
        <link rel="alternate" type="application/rss+xml" title="Z3&#32;-&#32;Discussions" url="http://z3.codeplex.com/project/feeds/rss?ProjectRSSFeed=codeplex%3a%2f%2fforum%2fz3"/>
        
        <link rel="alternate" type="application/rss+xml" title="Z3&#32;-&#32;Issues" url="http://z3.codeplex.com/project/feeds/rss?ProjectRSSFeed=codeplex%3a%2f%2fworkitem%2fz3"/>
        
        <link rel="alternate" type="application/rss+xml" title="Z3&#32;-&#32;Downloads" url="http://z3.codeplex.com/project/feeds/rss?ProjectRSSFeed=codeplex%3a%2f%2frelease%2fz3"/>
        <link rel="alternate" type="application/rss+xml" title="Z3&#32;-&#32;Reviews" url="http://z3.codeplex.com/project/feeds/rss?ProjectRSSFeed=codeplex%3a%2f%2freview%2fz3"/>
        
    
        <link rel="alternate" type="application/rss+xml" title="Z3&#32;-&#32;Source&#32;code" url="http://z3.codeplex.com/project/feeds/rss?ProjectRSSFeed=codeplex%3a%2f%2fsourcecontrol%2fz3"/>
        <link rel="alternate" type="application/rss+xml" title="Z3&#32;-&#32;Wiki" url="http://z3.codeplex.com/project/feeds/rss?ProjectRSSFeed=codeplex%3a%2f%2fwiki%2fz3"/>
    
        
    
    <meta content="summary" name="twitter:card"></meta><meta content="@CodePlex" name="twitter:site"></meta><meta content="http://z3.codeplex.com/workitem/42?ProjectName=z3" name="twitter:url"></meta><meta content="deadlock in free on timeout on win64" name="twitter:title"></meta><meta content="I think we&amp;#39;re basically seeing the windows version of issue 21 here.  If the timeout timer goes off while the main thread is holding a heap lock &amp;#40;perhaps because it is executing malloc or free&amp;#41;, this call to free during the timeout handler can deadlock.  &amp;#40;free is not reentrant&amp;#41;&amp;#13;&amp;#10;&amp;#10;It doesn&amp;#39;t happen often, but it happens from time to time.&amp;#13;&amp;#10;&amp;#10;ntdll&amp;#33; &amp;#63;&amp;#63; &amp;#58;&amp;#58;FNODOBFM&amp;#58;&amp;#58;&amp;#96;string&amp;#39;&amp;#43;0xd8d7&amp;#13;&amp;#10;ntdll&amp;#33;RtlpDeCommitFreeBlock&amp;#43;0x190&amp;#13;&amp;#10;ntdll&amp;#33;RtlpFreeHeap&amp;#43;0xa4d&amp;#13;&amp;#10;ntdll&amp;#33;RtlFreeHeap&amp;#43;0x1a6&amp;#13;&amp;#10;kernel32&amp;#33;HeapFree&amp;#43;0xa&amp;#13;&amp;#10;MSVCR100&amp;#33;free&amp;#43;0x1c&amp;#13;&amp;#10;MSVCP100&amp;#33;CRT_INIT&amp;#43;0x12f&amp;#13;&amp;#10;MSVCP100&amp;#33;CRT_INIT&amp;#43;0x345&amp;#13;&amp;#10;ntdll&amp;#33;LdrShutdownProcess&amp;#43;0x1db&amp;#13;&amp;#10;ntdll&amp;#33;RtlExitUserProcess&amp;#43;0x90&amp;#13;&amp;#10;MSVCR100&amp;#33;cinit&amp;#43;0x20d&amp;#13;&amp;#10;z3&amp;#33;on_timeout&amp;#43;0x11 &amp;#91;c&amp;#58;&amp;#92;bb&amp;#92;songvm-trunk-x86_64-pc-win64&amp;#92;build&amp;#92;third-party&amp;#92;z3&amp;#92;src&amp;#92;shell&amp;#92;smtlib_frontend.cpp&amp;#13;&amp;#10;&amp;#64; 62&amp;#93;&amp;#13;&amp;#10;z3&amp;#33;g_timeout_eh&amp;#58;&amp;#58;operator&amp;#40;&amp;#41;&amp;#43;0x28 &amp;#91;c&amp;#58;&amp;#92;bb&amp;#92;songvm-trunk-x86_64-pc-win64&amp;#92;build&amp;#92;third-party&amp;#92;z3&amp;#92;src&amp;#92;util&amp;#92;timeout.cpp &amp;#64; 40&amp;#93;&amp;#13;&amp;#10;ntdll&amp;#33;RtlpTpTimerCallback&amp;#43;0xcb&amp;#13;&amp;#10;ntdll&amp;#33;TppTimerpExecuteCallback&amp;#43;0x105&amp;#13;&amp;#10;ntdll&amp;#33;TppWorkerThread&amp;#43;0x5ff&amp;#13;&amp;#10;kernel32&amp;#33;BaseThreadInitThunk&amp;#43;0xd&amp;#13;&amp;#10;ntdll&amp;#33;RtlUserThreadStart&amp;#43;0x1d&amp;#10;" name="twitter:description"></meta><meta content="http://www.codeplex.com/favicon.ico" name="twitter:image"></meta>
    

    </head>
    
    <body>
        <script src="http://download-codeplex.sec.s-msft.com/scripts/v20552/i7/ScriptLoader.ashx" type="text/javascript"></script>
        <form id="aspnetForm" autocomplete="off" method="POST" enctype="multipart/form-data">
            <input name="__RequestVerificationToken" type="hidden" value="UD5FdTx1ZQUlAsh-ANzmgmUtQ5dqJvJf2SuCFfWN-h-eLyKnH9-g0cZhcUnk6m8yJe1U2ucHSlW6nezwK_ph88QFgDj3SiJQBqGgVjjwgarVdsMSPUd8sMlSrixjoqkb6KRbYA2" />
            
            <div id="UpdateProgressPanel" class="loading_animation" style="display:none;">
                <div class="row">
                    <h2 class="anim_h2">
                        <span id="UpdateProgressText">Updating...</span>
                        <span id="animatedLoadingIconContainer">
                            <img id="animatedLoadingIcon" src="http://download-codeplex.sec.s-msft.com/Images/v20552/loading_animation.gif" class="anim_img"/>
                        </span>
                    </h2>
                </div>
            </div>
            
            <div style="display:none;">
                
                    <script type="text/javascript">
                        $loadScript("https://siterecruit.comscore.com/sr/codeplex/broker.js");
                    </script>

                
                
                <img id="BlankImage" style="width:0;height:0;" src="http://download-codeplex.sec.s-msft.com/Images/v20552/blank.png" onload="self.logoImageLoaded=true;"/>

                <script language="javascript" type="text/javascript">
                    var date = new Date();
                    var timezoneOffset = date.getTimezoneOffset() / 60 * -1;
                    var timezoneOffsetCookie = getCookie("TimezoneOffset");
                    var firstTimeSetTimezoneCookie = false;

                    if (timezoneOffsetCookie == null || timezoneOffsetCookie != timezoneOffset) {
                        firstTimeSetTimezoneCookie = true;
                        document.cookie = "TimezoneOffset=" + timezoneOffset + '; domain=.codeplex.com;expires=Wed, 11 Jun 2014 23:11:18 UTC';
                    }
                </script>
                
                
                    <noscript>
                        <a href="http://www.omniture.com" title="Web Analytics"><img src="http://msstonojstemp.112.2O7.net/b/ss/msstonojstemp/1/H.20.2--NS/0" height="1" width="1" border="0" alt="" /></a>
                    </noscript>
                
            </div>
            
            <div id="header">
                <div id="header_wrap" class="row">
                    <p id="logo"><a href="http://www.codeplex.com">Code<span class="semi">Plex</span></a><span id="tagline">Project Hosting for Open Source Software</span></p>
                    

<ul id="nav">

    <li><a href="/site/register/new" id="registerLink" class="ZoomFix">Register</a></li>
    <li ><a class="SignInLink" href="https://www.codeplex.com/site/login?RedirectUrl=http%3a%2f%2fz3.codeplex.com%2fworkitem%2f42" id="signInLink">Sign In</a></li>
  
    <li class="last"><a class="rss_site_icon" href="http://www.codeplex.com/site/feeds/rss" type="application/rss+xml" rel="Alternate" title="CodePlex Site Activity"></a></li>
</ul>
                    <input id="searchsite" name="searchsite" maxlength="500" type="text" value="" /><span id="search_mag"><a id="submitSearch" name="submitSearch" class="magnify" title="Search" href="#"></a></span>
                    <script>
	$(document).ready(function() {
    var searchButton = $('#submitSearch'),
        searchBar = $('#searchsite');

    // Register our own handler for the search event while we wait for the SearchBox script to load.
    searchButton.bind('click.backupSearchBox', doProjectSearch);
    searchBar.bind('keypress.backupSearchBox', function(e) { if ($keyCode(e) === 13) { doProjectSearch(); return false; } });

    function cleanupSearchEvents() {
        // If the SearchBox was loaded, unregister our handlers.
        if (epx_loaded) {
            searchButton.unbind('.backupSearchBox');
            searchBar.unbind('.backupSearchBox');
        }
    }

    $loadScript('http://i4.services.social.microsoft.com/search/Widgets/SearchBox.jss?appid=1000&scopeid=1&boxId=searchsite&btnId=submitSearch&watermark=Search%20all%20projects&overrideWatermark=true&searchLocation=%2fsite%2fsearch&allowEmptySearch=true&focusOnInit=False&minimumTermLength=3', cleanupSearchEvents);
})
function doProjectSearch() {
    
    var url = '/site/search';

    //If search term is not same as watermark
    if($('#searchsite').val() != 'Search all projects')    
    {        
        url = url + '?query=' + encodeURIComponent($('#searchsite').val());
    }

    
    var callback = '';
    if (callback.length > 0 && eval('typeof ' + callback) != 'undefined')
        url += eval(callback + '()');

    window.location.href = url;
    return false;
}
</script>
                </div>
            </div>
            
            <div id="wrap">
                
    <div id="sub_heading" class="row">
        
        <div id="ProjectHeader">
            <div id="project_title_row" class="row">
                <div id="project_logo">
                    
    
    <h1><a href="http://z3.codeplex.com/"><img src="http://download-codeplex.sec.s-msft.com/Download?ProjectName=z3&DownloadId=491381&Build=20552" alt="Z3" /></a></h1>

                </div>
            </div>
        </div>
        
        <div id="ProjectDetailsDiv">
            
        </div>
		<div class="clear"></div>
        

<ul id="page_box_links">
	<li id="homeTabCell" style="width: 63px;"><a id="homeTab" href="http://z3.codeplex.com/" class="box_home">home</a><div></div></li>
    
	<li id="sourceTabCell" style="width:113px;"><a id="sourceTab" href="http://z3.codeplex.com/SourceControl/latest" class="box_source">source code</a><div></div></li>
    
	<li id="releasesTabCell" style="width:105px;"><a id="releasesTab" href="http://z3.codeplex.com/releases" class="box_downloads">downloads</a><div></div></li>
    
    <li id="documentationTabCell" style="width:143px;"><a id="documentationTab" href="http://z3.codeplex.com/documentation" class="box_documentation">documentation</a><div></div></li>
    
	<li id="discussionTabCell" style="width:112px;"><a id="discussionTab" href="http://z3.codeplex.com/discussions" class="box_discussions">discussions</a><div></div></li>
    
	<li id="workItemsTabCell" style="width:70px;"><a id="workItemsTab" href="http://z3.codeplex.com/workitem/list/basic" class="issue_active">issues</a><div></div></li>
    
	<li id="peopleTabCell" style="width:70px;"><a id="peopleTab" href="http://z3.codeplex.com/team/view" class="box_people">people</a><div></div></li>
	<li id="licenseTabCell" style="width:70px;"><a id="licenseTab" href="http://z3.codeplex.com/license" class="box_license">license</a><div></div></li>
    
    <span class="stretch"></span>
</ul>

<script type="text/javascript">
    $(document).ready(function () {
        $('#page_box_links').applyLastClassToList();
    });
</script>
		    <div class="clear"></div>
            
    

<div id="workitem_sub_menu">
    <ul class="page_box_sublinks">
        
            <li><a id="BasicLink" href="http://z3.codeplex.com/workitem/list/basic">Basic View</a></li>
        
            <li class="last"><a id="AdvancedLink" href="http://z3.codeplex.com/workitem/list/advanced">Advanced View</a></li>
        
    </ul>
    
    <div id="actionBar_placeholder">
        

<div>
    
    <div id="actionBar" class="action_bar">
        <ul id="actionBar_ul" class="actionBar_sublinks subtab_right" style="vertical-align: middle;">

            

                <li id="li_actionbar_newitem" data-action-id="actionbar_newitem" data-action-type="Navigate" class="actionBar_sublinks" data-options-id="df226991-fefc-488d-b5dc-1d2f52ce32f6">
                
                    <script class="options" defer="defer" id="df226991-fefc-488d-b5dc-1d2f52ce32f6" type="application/json">{"navigate-url":"http://z3.codeplex.com/WorkItem/Create"}</script> 
                    
                    <div class="actionBar_custom_content"></div>

                    <a href="#" id="actionbar_newitem" title="Create a new issue." class="action_bar_item_link">
                        <img id="img_actionbar_newitem" class="action_bar_item_image" src="http://download-codeplex.sec.s-msft.com/Images/v20552/actionbar_newitem.png" style="vertical-align: middle" />
                        New Issue
                    </a>

                </li>

            

                <li id="li_actionbar_subscribe" data-action-id="actionbar_subscribe" data-action-type="PopUp" class="actionBar_sublinks" data-options-id="e5f8ea89-278c-4dd9-a672-48ce5af4bfab">
                
                    <script class="options" defer="defer" id="e5f8ea89-278c-4dd9-a672-48ce5af4bfab" type="application/json">{}</script> 
                    
                    <div class="actionBar_custom_content">

<div id="rssHoverDiv" class="HoverPanel LeftHoverWidth" style="display: none">
        <ul id="3_FeedsPanel" class="RssFeedsPanel">
            <li>
                <a id="ProjectRssLink" href="http://z3.codeplex.com/project/feeds/rss" class="ArrowSmall NoUnderline">All Project Updates</a>
            </li>
            
            <li>
                <a id="DiscussionRssLink" href="http://z3.codeplex.com/project/feeds/rss?ProjectRSSFeed=codeplex%3a%2f%2fforum%2fz3" class="ArrowSmall NoUnderline">Discussions</a>
            </li>
            
            <li>
                <a id="IssueTrackerRssLink" href="http://z3.codeplex.com/project/feeds/rss?ProjectRSSFeed=codeplex%3a%2f%2fworkitem%2fz3" class="ArrowSmall NoUnderline">Issue Tracker</a>
            </li>
            
            <li>
                <a id="ReleasesRssLink" href="http://z3.codeplex.com/project/feeds/rss?ProjectRSSFeed=codeplex%3a%2f%2frelease%2fz3" class="ArrowSmall NoUnderline">Downloads</a>
            </li>
            <li>
                <a id="ReviewsRssLink" href="http://z3.codeplex.com/project/feeds/rss?ProjectRSSFeed=codeplex%3a%2f%2freview%2fz3" class="ArrowSmall NoUnderline">Reviews</a>
            </li>
            
            <li>
                <a id="SourceControlRssLink" href="http://z3.codeplex.com/project/feeds/rss?ProjectRSSFeed=codeplex%3a%2f%2fsourcecontrol%2fz3" class="ArrowSmall NoUnderline">Source Code</a>
            </li>
            <li>
                <a id="WikiRssLink" href="http://z3.codeplex.com/project/feeds/rss?ProjectRSSFeed=codeplex%3a%2f%2fwiki%2fz3" class="ArrowSmall NoUnderline">Wiki &amp; Documentation</a>
            </li>
        </ul>
</div></div>

                    <a href="#" id="actionbar_subscribe" title="Subscribe to project updates in RSS feeds." class="action_bar_item_link">
                        <img id="img_actionbar_subscribe" class="action_bar_item_image" src="http://download-codeplex.sec.s-msft.com/Images/v20552/actionbar_subscribe.png" style="vertical-align: middle" />
                        Subscribe
                    </a>

                </li>

            
        </ul>
    </div>
</div>
    </div>
    <div style="clear:both"></div>
</div>

<script type="text/javascript">
    function goToCreateItem() {
        $('#actionbar_newitem').click();
    }
</script>
        

    </div>
    
    
    
        <div id="ErrorPanel" class="modal" style="display: none">
            <div class="row">
                <h2><span class="title">Woops...</span><a href="#" class="close">X</a></h2>
            </div>
            <div class="modal_info">
                <p id="Message">An unexpected error has occured.</p>
                <p class="modal_buttons">
                    <input type="button" id="Ok" value="Ok" class="ok" />
                </p>
                <div class="ClearBoth"></div>
            </div>
        </div>
        <div id="PageIsDirtyPanel" class="modal" style="display: none">
            <div class="row">
                <h2><span class="title">Are you sure?</span><a href="#" class="close">X</a></h2>
            </div>
            <div class="modal_info">
                <p>There is an unsaved comment in progress. You will lose your changes if you continue. Are you sure you want to reopen the work item?</p>
                <p class="modal_buttons">
                    <input type="button" value="Reopen" class="ok" />
                    <input type="button" value="Cancel" class="cancel" />
                </p>
                <div class="ClearBoth"></div>
            </div>
        </div>

        <script type="text/javascript">
            $(document).ready(function() {
                setupUnsavedData();
                
                $('.votebox').voting({ 
                    voteUrl: "http://z3.codeplex.com/workitem/vote",
                    loginUrl: 'https://www.codeplex.com/site/login?RedirectUrl=http%3a%2f%2fz3.codeplex.com%2fworkitem%2f42'
                });
                
                
                
                $("#ChangeStatusCancel").click(function () {
                    $('#changeStatusHoverDiv').hide();
                    $('#li_actionbar_closeitem .action_bar_popup_arrow').hide();
                });
                
                
            });
            
            function UpdateReasonClosed() {
                var $link = $("#ReasonClosedLink"),
                    $reasonClosedSelect = $("#workItemReasonClosedDropDown"),
                    currentValue,
                    newValue,
                    newLinkLocation;

                // We need to update the link text and target to reflect the selection
                currentValue = $link.text();
                newValue = $reasonClosedSelect.val();
                newLinkLocation = $link.attr('href').replace("ReasonClosed=" + encodeURIComponent(currentValue), "ReasonClosed=" + encodeURIComponent(newValue));
                $link.text(newValue);
                $link.attr('href', newLinkLocation);
                $link.parent().parent().show();
            }
            
            function isWorkItemOpen() {
                return $('#actionbar_closeitem').attr("title") == 'Close the issue.';
            }

            
            $(document).ready(function() {
                var focus = $getQuerystring('FocusElement', '');
                if (focus != '')
                    $('#'+focus).focus();
            });
        </script>

    	<div id="left_column" class="issue_tracker_detail issuetracker_basic_view">
    		<div class="issue_title WordWrapBreakWord">
                <div class="issue_title_votebox">
                    

<div class="votebox" d:workItemId="42">
    
        <div id="VoteCountLabel_WorkItemId42" class="vote_bg_open">1</div>
        <p class="vote" id="VotedLabel_WorkItemId42" style="display: none;">Voted</p>
        
                <a id="VoteLink42" class="vote_loggedout" href="#" title="You must be logged in to use this feature.">Vote</a>
            
</div>
                </div>
                <h1 id="workItemTitle" class="page_title">deadlock in free on timeout on win64</h1>
            </div>
            <div class="clear"></div>

    		<h2>description</h2>
            <div class="markDownOutput " id="descriptionContent">I think we're basically seeing the windows version of issue 21 here.  If the timeout timer goes off while the main thread is holding a heap lock (perhaps because it is executing malloc or free), this call to free during the timeout handler can deadlock.  (free is not reentrant)<br />
<br />
It doesn't happen often, but it happens from time to time.<br />
<br />
ntdll! ?? ::FNODOBFM::`string'+0xd8d7<br />
ntdll!RtlpDeCommitFreeBlock+0x190<br />
ntdll!RtlpFreeHeap+0xa4d<br />
ntdll!RtlFreeHeap+0x1a6<br />
kernel32!HeapFree+0xa<br />
MSVCR100!free+0x1c<br />
MSVCP100!CRT_INIT+0x12f<br />
MSVCP100!CRT_INIT+0x345<br />
ntdll!LdrShutdownProcess+0x1db<br />
ntdll!RtlExitUserProcess+0x90<br />
MSVCR100!cinit+0x20d<br />
z3!on_timeout+0x11 [c:\bb\songvm-trunk-x86_64-pc-win64\build\third-party\z3\src\shell\smtlib_frontend.cpp<br />
@ 62]<br />
z3!g_timeout_eh::operator()+0x28 [c:\bb\songvm-trunk-x86_64-pc-win64\build\third-party\z3\src\util\timeout.cpp @ 40]<br />
ntdll!RtlpTpTimerCallback+0xcb<br />
ntdll!TppTimerpExecuteCallback+0x105<br />
ntdll!TppWorkerThread+0x5ff<br />
kernel32!BaseThreadInitThunk+0xd<br />
ntdll!RtlUserThreadStart+0x1d<br />
</div>

            <div class="hidden">
                <h2>file attachments</h2>
                

<div id="file_attachments">
    
	    <p>No files are attached</p>
    
</div>
            </div>

            <div id="ClosedDiv" class="Closed" style="display:none;">
                <div class="StandardPadding ModalBackgroundLight">
                    Closed <span id="ClosedOnDateTimeComment" class="smartDate"></span>
                    by <a id="ClosedByLink" href="http://www.codeplex.com/site/users/view/"></a><br />
                    <div id="ClosedCommentLabel">
                        <div class="markDownOutput "></div>
                    </div>
                </div>
                <br />
            </div>

            
<div id="comments">
	<h2>comments</h2>
    <div id="CommentsList">
        
            <div id="CommentContainer0">
			    <p class="comment_info">
                    <a class="author" id="PostedByLink0" href="http://www.codeplex.com/site/users/view/dvitek">dvitek</a>
                    wrote <span id="PostedOnDateTime0" class="smartDate" title="5/29/2013 5:56:43 PM" LocalTimeTicks="1369875403">May 29 at 5:56 PM</span>
                    
                </p>
                
                <div class="comment_divider">
                    <div class="markDownOutput ">In case it is important, the above was the only thread in the z3 process, besides the windbg breakin thread.<br />
</div>
                </div>
            </div>
        
            <div id="CommentContainer1">
			    <p class="comment_info">
                    <a class="author" id="PostedByLink1" href="http://www.codeplex.com/site/users/view/dvitek">dvitek</a>
                    wrote <span id="PostedOnDateTime1" class="smartDate" title="5/29/2013 6:00:43 PM" LocalTimeTicks="1369875643">May 29 at 6:00 PM</span>
                    
                </p>
                
                <div class="comment_divider">
                    <div class="markDownOutput ">Now that I look at this a bit more, I'm not confident about my explanation.  Do the timeouts fire in a separate thread or do they hijack the main thread?  Something more strange may be afoot if they run in a separate thread.<br />
</div>
                </div>
            </div>
        
            <div id="CommentContainer2">
			    <p class="comment_info">
                    <a class="author" id="PostedByLink2" href="http://www.codeplex.com/site/users/view/leodemoura">leodemoura</a>
                    wrote <span id="PostedOnDateTime2" class="smartDate" title="5/30/2013 1:29:03 AM" LocalTimeTicks="1369902543">May 30 at 1:29 AM</span>
                    
                </p>
                
                <div class="comment_divider">
                    <div class="markDownOutput ">I didn't manage to reproduce the error yet on my machine.<br />
It is not clear to me what is going on. It seems the Z3 process crashed executing <code>exit(0)</code>.<br />
</div>
                </div>
            </div>
        
            <div id="CommentContainer3">
			    <p class="comment_info">
                    <a class="author" id="PostedByLink3" href="http://www.codeplex.com/site/users/view/dvitek">dvitek</a>
                    wrote <span id="PostedOnDateTime3" class="smartDate" title="5/30/2013 2:40:04 AM" LocalTimeTicks="1369906804">May 30 at 2:40 AM</span>
                    
                </p>
                
                <div class="comment_divider">
                    <div class="markDownOutput ">It isn't a crash; it's a deadlock, which I presume arises due to a race condition.  It is very hard to reproduce (we see it maybe a couple times a day out of perhaps millions of runs per day).<br />
<br />
In this case z3 ran with a one second timeout and somebody noticed it had been running all night without exiting.  We attached windbg and found the only thread of the process was stuck with the above stack trace.  The thread is attempting to run exit, but isn't making progress.  I'm not sure if it was livelocked or deadlocked, but there will probably be another like it in the morning.<br />
<br />
I believe it is contingent on the timeout event firing at just the wrong time.<br />
<br />
A normal healthy z3 process with a timeout running an smtlib2 problem has three threads:<br />
1) The &quot;main&quot; thread starting at main()<br />
2) <br />
ntdll!NtWaitForWorkViaWorkerFactory+0xa<br />
ntdll!TppWorkerThread+0x2c9<br />
kernel32!BaseThreadInitThunk+0xd<br />
ntdll!RtlUserThreadStart+0x1d<br />
<br />
3)<br />
ntdll!ZwWaitForMultipleObjects+0xa<br />
ntdll!TppWaiterpThread+0x14d<br />
kernel32!BaseThreadInitThunk+0xd<br />
ntdll!RtlUserThreadStart+0x1d<br />
<br />
<br />
This &quot;stuck&quot; process has only thread #2.  I suspect threads #2 and #3 get created by the Windows API functions used to implement the timout functionality.  Somehow threads #1 and #3 have ended and only #2 remains, and furthermore it is not making progress.<br />
<br />
I wonder if perhaps this can happen if the timeout event fires essentially at the same time that the main thread exits.  Does the timeout event get unregistered before the main thread invokes exit or returns?<br />
</div>
                </div>
            </div>
        
            <div id="CommentContainer4">
			    <p class="comment_info">
                    <a class="author" id="PostedByLink4" href="http://www.codeplex.com/site/users/view/dvitek">dvitek</a>
                    wrote <span id="PostedOnDateTime4" class="smartDate" title="5/31/2013 11:32:30 PM" LocalTimeTicks="1370068350">May 31 at 11:32 PM</span>
                    
                </p>
                
                <div class="comment_divider">
                    <div class="markDownOutput ">I now also have a crash, which is presumably also caused by a race condition against the timeout event.  I imagine exciting stuff can happen if all the global destructors start running concurrently with the main thread.<br />
<pre><code>.  0  Id: 190.1e2c Suspend: 1 Teb: 000007ff`fffde000 Unfrozen
      Start: z3!mainCRTStartup (00000001`4064be90) 
      Priority: 0  Priority class: 32  Affinity: f
Child-SP          RetAddr           Call Site
00000000`0015e798 00000000`77aa57e0 ntdll!ZwWaitForSingleObject+0xa
00000000`0015e7a0 00000000`77aa62b3 ntdll!RtlReportExceptionEx+0x1d0
00000000`0015e880 00000000`77aa630a ntdll!RtlReportException+0x33
00000000`0015e8b0 00000000`77aa7b95 ntdll!RtlpTerminateFailureFilter+0x1a
00000000`0015e8e0 00000000`77a3e22d ntdll!RtlReportCriticalFailure+0x96
00000000`0015e910 00000000`77a3d6bd ntdll!_C_specific_handler+0x8c
00000000`0015e980 00000000`77a3dfd7 ntdll!RtlpExecuteHandlerForException+0xd
00000000`0015e9b0 00000000`77a3e3c1 ntdll!RtlDispatchException+0x20c
00000000`0015f050 00000000`77aa7b47 ntdll!RtlRaiseException+0xe1
00000000`0015f660 00000000`77aa8686 ntdll!RtlReportCriticalFailure+0x67
00000000`0015f730 00000000`77aa9de6 ntdll!RtlpReportHeapFailure+0x26
00000000`0015f760 00000000`77aab6f4 ntdll!RtlpHeapHandleError+0x16
00000000`0015f790 00000000`77aabcd9 ntdll!RtlpLogHeapFailure+0xa4
00000000`0015f7c0 00000000`77a51935 ntdll!RtlpAnalyzeHeapFailure+0x3a9
00000000`0015f820 00000000`77a48747 ntdll!RtlpFreeHeap+0x1364
00000000`0015fb40 00000000`778fc7da ntdll!RtlFreeHeap+0x1a2
00000000`0015fbc0 00000000`73968d94 kernel32!HeapFree+0xa
00000000`0015fbf0 00000001`405fb964 MSVCR100!free+0x1c
00000000`0015fc20 00000001`3fdc6042 z3!memory::deallocate(void * p = 0x00000000`001e94e8)+0x94 [c:\tb\augur-csotaint_smt-codesonar-tests-x86_64-pc-win64\build\third-party\z3\src\util\memory_manager.cpp @ 198]
00000000`0015fc70 00000001`3fdc2fe3 z3!vector&lt;unsigned __int64,0&gt;::free_memory(void)+0x32 [c:\tb\augur-csotaint_smt-codesonar-tests-x86_64-pc-win64\build\third-party\z3\src\util\vector.h @ 55]
00000000`0015fca0 00000001`40647378 z3!vector&lt;unsigned __int64,0&gt;::destroy(void)+0x43 [c:\tb\augur-csotaint_smt-codesonar-tests-x86_64-pc-win64\build\third-party\z3\src\util\vector.h @ 108]
00000000`0015fcd0 00000001`40646ff8 z3!vector&lt;unsigned __int64,0&gt;::finalize(void)+0x28 [c:\tb\augur-csotaint_smt-codesonar-tests-x86_64-pc-win64\build\third-party\z3\src\util\vector.h @ 178]
00000000`0015fd00 00000001`40647221 z3!prime_generator::finalize(void)+0x28 [c:\tb\augur-csotaint_smt-codesonar-tests-x86_64-pc-win64\build\third-party\z3\src\util\prime_generator.cpp @ 82]
00000000`0015fd30 00000001`405fb685 z3!prime_iterator::finalize(void)+0x21 [c:\tb\augur-csotaint_smt-codesonar-tests-x86_64-pc-win64\build\third-party\z3\src\util\prime_generator.cpp @ 128]
00000000`0015fd60 00000001`3fbf3b98 z3!memory::finalize(void)+0x35 [c:\tb\augur-csotaint_smt-codesonar-tests-x86_64-pc-win64\build\third-party\z3\src\util\memory_manager.cpp @ 104]
00000000`0015fd90 00000001`3fbf25a7 z3!global_state_initialiser::reset(void)+0x28 [c:\tb\augur-csotaint_smt-codesonar-tests-x86_64-pc-win64\build\third-party\z3\src\shell\main.cpp @ 374]
00000000`0015fdc0 00000001`4064bd0e z3!main(int argc = 4, char ** argv = 0x00000000`00797220)+0x327 [c:\tb\augur-csotaint_smt-codesonar-tests-x86_64-pc-win64\build\third-party\z3\src\shell\main.cpp @ 447]
00000000`0015fe70 00000000`778f466d z3!__tmainCRTStartup(void)+0x11a [f:\dd\vctools\crt_bld\self_64_amd64\crt\src\crtexe.c @ 555]
00000000`0015fea0 00000000`77a28181 kernel32!BaseThreadInitThunk+0xd
00000000`0015fed0 00000000`00000000 ntdll!RtlUserThreadStart+0x1d

.  1  Id: 190.1408 Suspend: 1 Teb: 000007ff`fffdc000 Unfrozen
      Start: ntdll!TppWorkerThread (00000000`77a40480) 
      Priority: 0  Priority class: 32  Affinity: f
Child-SP          RetAddr           Call Site
00000000`00b3f2f8 00000000`77a1f28a ntdll!ZwWaitForSingleObject+0xa
00000000`00b3f300 00000000`77a1f17d ntdll!RtlpWaitOnCriticalSection+0xea
00000000`00b3f3b0 00000000`77a1f8cd ntdll!RtlEnterCriticalSection+0xf4
00000000`00b3f3e0 00000000`77a48747 ntdll!RtlpFreeHeap+0x133b
00000000`00b3f700 00000000`778fc7da ntdll!RtlFreeHeap+0x1a2
00000000`00b3f780 00000000`73968d94 kernel32!HeapFree+0xa
00000000`00b3f7b0 00000000`7391f6e0 MSVCR100!free+0x1c
00000000`00b3f7e0 00000000`7391f992 MSVCR100!__ExceptionPtr::~__ExceptionPtr+0x70
00000000`00b3f810 00000000`73990610 MSVCR100!_DeleteExceptionPtr+0xe
00000000`00b3f840 00000000`73920c4b MSVCR100!_GSHandlerCheck_EH+0x1ccc
00000000`00b3f870 00000001`3fbfbb72 MSVCR100!cinit+0x18b
00000000`00b3f8e0 00000001`405fbe01 z3!on_timeout(void)+0x22 [c:\tb\augur-csotaint_smt-codesonar-tests-x86_64-pc-win64\build\third-party\z3\src\shell\smtlib_frontend.cpp @ 63]
00000000`00b3f910 00000001`4062079a z3!g_timeout_eh::operator()(void)+0x41 [c:\tb\augur-csotaint_smt-codesonar-tests-x86_64-pc-win64\build\third-party\z3\src\util\timeout.cpp @ 40]
00000000`00b3f970 00000000`77a11d23 z3!scoped_timer::imp::abort_proc(void * param = 0x00000000`007978e8, unsigned char timer_or_wait_fired = 0x01 '')+0x5a [c:\tb\augur-csotaint_smt-codesonar-tests-x86_64-pc-win64\build\third-party\z3\src\util\scoped_timer.cpp @ 87]
00000000`00b3f9b0 00000000`77a11be3 ntdll!RtlpTpTimerCallback+0xc3
00000000`00b3f9f0 00000000`77a407a0 ntdll!TppTimerpExecuteCallback+0x103
00000000`00b3fa50 00000000`778f466d ntdll!TppWorkerThread+0x3d6
00000000`00b3fcd0 00000000`77a28181 kernel32!BaseThreadInitThunk+0xd
00000000`00b3fd00 00000000`00000000 ntdll!RtlUserThreadStart+0x1d

.  2  Id: 190.1064 Suspend: 1 Teb: 000007ff`fffda000 Unfrozen
      Start: ntdll!TppWaiterpThread (00000000`77a3f7d0) 
      Priority: 0  Priority class: 32  Affinity: f
Child-SP          RetAddr           Call Site
00000000`00ccf758 00000000`77a3f91d ntdll!ZwWaitForMultipleObjects+0xa
00000000`00ccf760 00000000`778f466d ntdll!TppWaiterpThread+0x14d
00000000`00ccfa00 00000000`77a28181 kernel32!BaseThreadInitThunk+0xd
00000000`00ccfa30 00000000`00000000 ntdll!RtlUserThreadStart+0x1d

.  3  Id: 190.1540 Suspend: 1 Teb: 000007ff`fffd8000 Unfrozen
      Start: ntdll!TppWorkerThread (00000000`77a40480) 
      Priority: 0  Priority class: 32  Affinity: f
Child-SP          RetAddr           Call Site
00000000`0097fc28 00000000`77a4063e ntdll!NtWaitForWorkViaWorkerFactory+0xa
00000000`0097fc30 00000000`778f466d ntdll!TppWorkerThread+0x23e
00000000`0097feb0 00000000`77a28181 kernel32!BaseThreadInitThunk+0xd
00000000`0097fee0 00000000`00000000 ntdll!RtlUserThreadStart+0x1d</code></pre>

</div>
                </div>
            </div>
        
            <div id="CommentContainer5">
			    <p class="comment_info">
                    <a class="author" id="PostedByLink5" href="http://www.codeplex.com/site/users/view/dvitek">dvitek</a>
                    wrote <span id="PostedOnDateTime5" class="smartDate" title="5/31/2013 11:54:10 PM" LocalTimeTicks="1370069650">May 31 at 11:54 PM</span>
                    
                </p>
                
                <div class="comment_divider">
                    <div class="markDownOutput ">I am presently considering having the on_timeout procedure invoke TerminateProcess(GetCurrentProcess(), magic_number) as a stop-gap, since I don't see a quick path to success (other than having the main thread poll a variable).  Hope the dlls z3 loads don't have too much global state.<br />
</div>
                </div>
            </div>
        
            <div id="CommentContainer6">
			    <p class="comment_info">
                    <a class="author" id="PostedByLink6" href="http://www.codeplex.com/site/users/view/NikolajBjorner">NikolajBjorner</a>
                    wrote <span id="PostedOnDateTime6" class="smartDate" title="6/2/2013 6:47:25 PM" LocalTimeTicks="1370224045">Jun 2 at 6:47 PM</span>
                    
                </p>
                
                <div class="comment_divider">
                    <div class="markDownOutput ">The code for smtlib that handles user-defined timeouts is not thread safe, so if Z3 <br />
terminates precisely at the moment of a timeout it can very possibly lead to crashes.<br />
We will look into a fix for this scenario which is possibly influencing your runs.<br />
<br />
Setting /T:timeout on Z3 allows retrieving statistics on termination. <br />
Otherwise, external process control is as good (and isn't fragile).<br />
<br />
The calls to free should be thread-safe.<br />
The last stack provided seems to expose a different <br />
scenario either a heap corruption or a case of memory <br />
pressure. Without too much other information, I wonder <br />
could the first thread (Id: 190.1e2c) be stuck already before the timeout happens?<br />
</div>
                </div>
            </div>
        
    </div>
</div>


            <fieldset class="narrow row inline">
                <div class="row">
                    
                        <p><a id="LoginLink" href="https://www.codeplex.com/site/login?RedirectUrl=http%3a%2f%2fz3.codeplex.com%2fworkitem%2f42%3fFocusElement%3dCommentTextBox">Sign in to add a comment or to set email notifications</a></p>
                    
                    <div class="clear"></div>
                </div>

                
            </fieldset>
        </div>
    
        <script type="text/javascript">
            $(document).ready(function () {
                $(document).keyboardShortcuts({
                    createItem: goToCreateItem,
                    previousItem: goToPreviousItem,
                    nextItem: goToNextItem
                    
                });
            });
        </script>

    
        
    
    <div id="right_sidebar_noborder" >
        
<div style="margin-bottom: 10px; float: right">
            <span style="margin-right: 1.5em">Item <span id="CurrentItemIndexLabel">2</span> of <span id="TotalItemCountLabel">3</span></span>
            <span class="NextPrevious">
                
                <a id="PreviousItemLink" href="http://z3.codeplex.com/workitem/47">Previous</a>
                
                |
                
                <a id="NextItemLink" href="http://z3.codeplex.com/workitem/21">Next</a>
                
            </span>
    </div>
    
<div class="clear"></div>
    <script type="text/javascript">
        function goToPreviousItem() {
            $goToLinkHref('PreviousItemLink');
        }
        function goToNextItem() {
            $goToLinkHref('NextItemLink');
        }
    </script>


<div class="right_sidebar_table">
    <h2>work item details</h2>

    <table>
        <tr>
            <td class="left">Item number:</td>
            <td class="right">42</td>
        </tr>
        <tr>
            <td class="left">User comments:</td>
            <td class="right">7</td>
        </tr>
        <tr>
            <td class="left">Status:</td>
            <td class="right"><a id="StatusLink" href="http://z3.codeplex.com/workitem/list/advanced?Status=Proposed">Proposed</a></td>
        </tr>
        <tr style="display: none">
            <td class="left">Reason Closed:</td>
            <td class="right"><a id="ReasonClosedLink" href="http://z3.codeplex.com/workitem/list/advanced?status=Closed&ReasonClosed=Unassigned">Unassigned</a></td>
        </tr>
        <tr class="hidden">
            <td class="left">Type:</td>
            <td class="right"><a id="TypeLink" href="http://z3.codeplex.com/workitem/list/advanced?Type=Unassigned">Unassigned</a></td>
        </tr>
        <tr class="hidden">
            <td class="left">Impact:</td>
            <td class="right"><a id="ImpactLink" href="http://z3.codeplex.com/workitem/list/advanced?Priority=Unassigned">Unassigned</a></td>
        </tr>
        <tr class="hidden">
            <td class="left">Release:</td>
            <td class="right">
                
                <a id="ReleaseLink" href="http://z3.codeplex.com/workitem/list/advanced?Release=Unassigned">Unassigned</a>
            </td>
        </tr>
        <tr class="hidden">
            <td class="left">Assigned to:</td>
            <td class="right">
                
                <a id="AssignedToLink" href="http://z3.codeplex.com/workitem/list/advanced?AssignedTo=Unassigned">Unassigned</a>
            </td>
        </tr>
        <tr class="hidden">
            <td class="left">Component:</td>
            <td class="right">
                <a id="ComponentLink" href="http://z3.codeplex.com/workitem/list/advanced?Component="></a>
            </td>
        </tr>
        <tr>
            <td class="left">Reported on:<br />Reported by:<br /></td>
            <td class="right"><span id="ReportedOnDateTime" class="smartDate" title="5/29/2013 5:53:43 PM" LocalTimeTicks="1369875223">May 29 at 5:53 PM</span><br />
                <a id="ReportedByLink" class="author" href="http://www.codeplex.com/site/users/view/dvitek">dvitek</a>
                
            </td>
        </tr>
        <tr>
	        <td class="left">Updated on:<br />Updated by:</td>
            <td class="right"><span id="UpdatedOnDateTime" class="smartDate" title="6/2/2013 6:47:25 PM" LocalTimeTicks="1370224045">Jun 2 at 6:47 PM</span><br />
	            <a id="UpdatedByLink" class="author" href="http://www.codeplex.com/site/users/view/NikolajBjorner">NikolajBjorner</a>
            </td>
        </tr>
        <tr class="hidden">
	        <td class="left">Closed on:<br />Closed by:</td>
            <td class="right"><span id="ClosedOnDateTime" class="smartDate">n/a</span><br />
	            <a id="ClosedByAnchor" class="author" style="display: none;" href="http://www.codeplex.com/site/users/view/"></a>
                <span id="ClosedByNA" style="display: block;">n/a</span>
            </td>
        </tr>
        
    </table>
</div>


<p><a title="Keyboard Shortcuts" class="keyboard_icon" href="#" onclick="$(document).trigger('shortcuts');return false;"></a><a href="#" onclick="$(document).trigger('shortcuts');return false;">Keyboard shortcuts</a> are available for this page.</p>

    </div>

        
                
                <div class="clear"></div>
                
                <div id="footer">
                    <div class="row">
                        <hr />
                        <ul>
                            <li>© 2006-2013 Microsoft</li>
                            <li><a href="http://www.codeplex.com/site/help">Get Help</a></li>
                            <li><a href="/site/legal/privacy">Privacy Statement</a></li>
                            <li><a href="http://www.codeplex.com/site/legal/terms">Terms of Use</a></li>
                            <li><a href="http://www.codeplex.com/site/legal/conduct">Code of Conduct</a></li>
                            <li><a href="http://www.lakequincy.com" target="_blank">Advertise With Us</a></li>
                            <li>Version 6.4.2013.20552</li>
                        </ul>
                    </div>
                </div>
            </div>
        </form>
    </body>

</html>